<!DOCTYPE html>
{% load static %}
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}ComplyLaw{% endblock %}</title>
    <script src="https://unpkg.com/htmx.org@1.9.10"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
	<link rel="apple-touch-icon" sizes="180x180" href="{% static 'img/apple-touch-icon.png' %}">
	<link rel="icon" type="image/png" sizes="32x32" href="{% static 'img/favicon-32x32.png' %}">
	<link rel="icon" type="image/png" sizes="16x16" href="{% static 'img/favicon-16x16.png' %}">
	<link rel="icon" type="image/x-icon" href="{% static 'img/favicon.ico' %}">
	<link rel="manifest" href="{% static '/site.webmanifest' %}">
    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>
	<!-- Tailwind (CDN for demo – use compiled in prod) -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: { extend: { colors: { primary: '#6366f1' } } }
        }
    </script>

    <!-- HTMX -->
    <script src="https://unpkg.com/htmx.org@2.0.0"></script>
    <!-- Alpine (optional dropdowns) -->
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

    
	{% block extra_head %}{% endblock %}
	
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen flex flex-col">
    <!-- Navbar -->
    <!-- Navbar -->
    <nav class="bg-white shadow-sm border-b border-gray-200">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center">
                    <a href="/">
                        <img class="h-10 w-auto" src="{% static 'img/logo.png' %}" alt="ComplyLaw">
                    </a>
                </div>
                <div class="flex items-center space-x-6">
                    {% if user.is_authenticated %}
                        {% url 'dashboard:home' as dashboard_url %}
                        {% if dashboard_url %}
                            <a href="{{ dashboard_url }}" class="text-gray-700 hover:text-indigo-600 font-medium">Dashboard</a>
                        {% endif %}

                        {% url 'scanner:scan_list' as scan_list_url %}
                        {% if scan_list_url %}
                            <a href="{{ scan_list_url }}" class="text-gray-700 hover:text-indigo-600 font-medium">Scans</a>
                        {% endif %}

                        {% url 'reports:report_list' as report_list_url %}
                        {% if report_list_url %}
                            <a href="{{ report_list_url }}" class="text-gray-700 hover:text-indigo-600 font-medium">Reports</a>
                        {% endif %}

                        {% url 'users:profile' as profile_url %}
                        {% if profile_url %}
                            <a href="{{ profile_url }}" class="text-gray-700 hover:text-indigo-600 font-medium">Profile</a>
                        {% endif %}

                        <form method="post" action="{% url 'account_logout' %}" class="inline">
                            {% csrf_token %}
                            <button type="submit" class="text-red-600 hover:text-red-800 font-medium">Logout</button>
                        </form>
                    {% else %}
                        <a href="{% url 'account_login' %}" class="text-indigo-600 hover:text-indigo-800 font-medium">Login</a>
                        <a href="{% url 'account_signup' %}" class="bg-indigo-600 text-white px-5 py-2 rounded-lg hover:bg-indigo-700 font-medium">Sign Up</a>
                    {% endif %}
                </div>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <main class="flex-1 container max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
        {% if messages %}
		  <div class="fixed top-4 right-4 z-50 space-y-3">
			{% for message in messages %}
			  {% if "scan_in_progress" in message.tags or "scan_started" in message.tags %}
				<!-- Only show scan messages as toast (disappear automatically) -->
				<div x-data="{ show: true }" x-show="show" x-transition x-init="setTimeout(() => show = false, 5000)"
					 class="bg-blue-50 border border-blue-200 text-blue-800 px-4 py-3 rounded-lg shadow-lg flex items-center justify-between max-w-sm">
				  <span>{{ message }}</span>
				  <button @click="show = false" class="ml-4 text-blue-600 hover:text-blue-800">
					×
				  </button>
				</div>
			  {% else %}
				<!-- Regular messages (errors, success, etc.) -->
				<div class="bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded-lg shadow mb-3">
				  {{ message }}
				</div>
			  {% endif %}
			{% endfor %}
		  </div>
		{% endif %}

        {% block content %}{% endblock %}
    </main>

    <!-- Footer -->
    <footer class="bg-white border-t border-gray-200 mt-auto">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 text-center text-sm text-gray-500">
            © 2025 ComplyLaw. All rights reserved.
        </div>
    </footer>
<!--	
<div id="modal-container"></div>


{% if messages %}
  <div class="container mx-auto p-4">
    {% for message in messages %}
      <div class="bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded mb-4">
        {{ message }}
      </div>
    {% endfor %}
  </div>
{% endif %}
-->
{% block scripts %}{% endblock %}

<!-- Live Notification Toast -->
<div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-3">
</div>

<script>
(function() {
    const userId = "{{ user.id }}";
    if (!userId) return;

    const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
    const socket = new WebSocket(`${wsScheme}://${window.location.host}/ws/notifications/`);

    socket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        if (data.type === "notification") {
            showToast(data.message, data.grade);
        }
    };

    function showToast(message, grade) {
        const toast = document.createElement("div");
        toast.className = `max-w-sm w-full bg-white shadow-lg rounded-lg pointer-events-auto ring-1 ring-black ring-opacity-5 overflow-hidden transform transition-all duration-300 translate-y-10 opacity-0`;
        
        const gradeColor = grade === "A" ? "bg-green-500" :
                          grade === "B" ? "bg-blue-500" :
                          grade === "C" ? "bg-yellow-500" :
                          grade === "D" ? "bg-orange-500" : "bg-red-500";

        toast.innerHTML = `
            <div class="p-4">
                <div class="flex items-start">
                    <div class="flex-shrink-0">
                        <svg class="h-6 w-6 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <div class="ml-3 w-0 flex-1">
                        <p class="text-sm font-medium text-gray-900">${message}</p>
                        <p class="mt-1 text-xs text-gray-500">Grade: <strong>${grade}</strong> • Risk: ${data.risk_score}%</p>
                    </div>
                    <div class="ml-4 flex-shrink-0 flex">
                        <button onclick="this.parentElement.parentElement.parentElement.parentElement.remove()" class="text-gray-400 hover:text-gray-500">
                            <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"/></svg>
                        </button>
                    </div>
                </div>
            </div>
        `;

        // Add color bar
        const bar = document.createElement("div");
        bar.className = `h-1 ${gradeColor}`;
        bar.style.width = "0%";
        toast.appendChild(bar);

        document.getElementById("toast-container").prepend(toast);

        // Animate in
        setTimeout(() => {
            toast.classList.remove("translate-y-10", "opacity-0");
            bar.style.width = "100%";
            bar.style.transition = "width 5s linear";
        }, 100);

        // Auto-remove after 6s
        setTimeout(() => {
            toast.style.transform = "translateX(100%)";
            toast.style.opacity = "0";
            setTimeout(() => toast.remove(), 300);
        }, 6000);
    }
})();
</script>

<!-- EPIC CONFetti CELEBRATION FOR GRADE A -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>
<script>
(function() {
    // Only trigger once per page load
    let hasCelebrated = false;

    // Listen for our notification WebSocket
    const userId = "{{ user.id }}";
    if (!userId) return;

    const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
    const socket = new WebSocket(`${wsScheme}://${window.location.host}/ws/notifications/`);

    socket.onmessage = function(e) {
        const data = JSON.parse(e.data);
        if (data.type !== "notification") return;

        const message = data.message || "";
        const grade = data.grade;

        // NORMAL TOAST (for B, C, D, etc.)
        if (grade && grade !== "A") {
            showToast(message, grade);
            return;
        }

        // GRADE A = ULTIMATE CELEBRATION
        if (grade === "A" && !hasCelebrated) {
            hasCelebrated = true;
            celebrateGradeA(message);
        }
    };

    function showToast(message, grade) {
        const toast = document.createElement("div");
        toast.className = "max-w-sm w-full bg-white shadow-2xl rounded-xl pointer-events-auto ring-1 ring-black ring-opacity-5 overflow-hidden transform transition-all duration-500 scale-95 opacity-0";
        toast.innerHTML = `
            <div class="p-5">
                <div class="flex items-center">
                    <div class="flex-shrink-0">
                        <svg class="h-8 w-8 text-green-600" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                        </svg>
                    </div>
                    <div class="ml-4">
                        <p class="text-lg font-bold text-gray-900">${message}</p>
                        <p class="text-sm text-gray-600">Grade: <span class="font-bold text-2xl text-green-600">A</span></p>
                    </div>
                </div>
            </div>
        `;
        document.getElementById("toast-container").prepend(toast);
        setTimeout(() => toast.classList.remove("scale-95", "opacity-0"), 100);
        setTimeout(() => toast.remove(), 8000);
    }

    function celebrateGradeA(message) {
        // 1. Victory sound
        const audio = new Audio("https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.mp3");
        audio.volume = 0.6;
        audio.play().catch(() => {});

        // 2. MEGA CONFETTI EXPLOSION
        const duration = 6 * 1000;
        const animationEnd = Date.now() + duration;
        const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 9999 };

        function randomInRange(min, max) {
            return Math.random() * (max - min) + min;
        }

        const interval = setInterval(function() {
            const timeLeft = animationEnd - Date.now();
            if (timeLeft <= 0) return clearInterval(interval);

            const particleCount = 80 * (timeLeft / duration);
            confetti(Object.assign({}, defaults, {
                particleCount,
                origin: { x: randomInRange(0.1, 0.3), y: Math.random() - 0.2 }
            }));
            confetti(Object.assign({}, defaults, {
                particleCount,
                origin: { x: randomInRange(0.7, 0.9), y: Math.random() - 0.2 }
            }));
        }, 250);

        // 3. Final big burst
        setTimeout(() => {
            confetti({
                particleCount: 300,
                spread: 120,
                origin: { y: 0.6 },
                colors: ['#10b981', '#34d399', '#86efac', '#d9f99d', '#fbbf24']
            });
        }, 2000);

        // 4. Show epic toast
        const epicToast = document.createElement("div");
        epicToast.className = "fixed inset-0 flex items-center justify-center z-[99999] pointer-events-none";
        epicToast.innerHTML = `
            <div class="bg-gradient-to-br from-green-400 via-emerald-500 to-teal-600 text-white px-12 py-10 rounded-3xl shadow-2xl transform scale-0 animate-ping-once">
                <div class="text-center">
                    <div class="text-6xl font-black mb-4 animate-bounce">A</div>
                    <div class="text-3xl font-bold">${message}</div>
                    <div class="text-xl mt-3 opacity-90">Outstanding Compliance!</div>
                </div>
            </div>
        `;
        document.body.appendChild(epicToast);
        setTimeout(() => epicToast.remove(), 5000);
    }

    // Tiny CSS animation
    const style = document.createElement('style');
    style.textContent = `
        @keyframes ping-once {
            0% { transform: scale(0); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: scale(1.1); opacity: 0; }
        }
        .animate-ping-once { animation: ping-once 4s cubic-bezier(0, 0, 0.2, 1) forwards; }
    `;
    document.head.appendChild(style);
})();
</script>

</body>
</html>