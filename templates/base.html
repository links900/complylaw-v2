<!DOCTYPE html>
{% load static %}
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}ComplyLaw{% endblock %}</title>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">

    <!-- Favicon & PWA -->
    <link rel="apple-touch-icon" sizes="180x180" href="{% static 'img/apple-touch-icon.png' %}">
    <link rel="icon" type="image/png" sizes="32x32" href="{% static 'img/favicon-32x32.png' %}">
    <link rel="icon" type="image/png" sizes="16x16" href="{% static 'img/favicon-16x16.png' %}">
    <link rel="icon" type="image/x-icon" href="{% static 'img/favicon.ico' %}">
    <link rel="manifest" href="{% static '/site.webmanifest' %}">

    <style>
        body { font-family: 'Inter', sans-serif; }
    </style>

    <!-- HTMX & Alpine -->
    <script src="https://unpkg.com/htmx.org@2.0.0"></script>
    <script defer src="https://unpkg.com/alpinejs@3.x.x/dist/cdn.min.js"></script>

    {% block extra_head %}{% endblock %}
</head>
<body class="bg-gray-50 text-gray-900 min-h-screen flex flex-col">

<!-- Navbar -->
<nav class="bg-white shadow-sm border-b border-gray-200">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex justify-between h-16">
            <div class="flex items-center">
                <img src="{% static 'img/logo.png' %}" alt="Logo" style="width: 140px; height: auto;">
            </div>
            <div class="flex items-center space-x-4">
                {% if user.is_authenticated %}
                    <a href="{% url 'dashboard:home' %}" class="text-gray-700 hover:text-blue-600">Dashboard</a>
                    <a href="{% url 'scanner:scan_list' %}" class="text-gray-700 hover:text-blue-600">Scans</a>
                    <a href="{% url 'reports:report_list' %}" class="text-gray-700 hover:text-blue-600">Reports</a>
                    <a href="{% url 'users:profile' %}" class="text-gray-700 hover:text-blue-600">Profile</a>
                    <form method="post" action="{% url 'account_logout' %}" class="inline">
                        {% csrf_token %}
                        <button type="submit" class="text-red-600 hover:text-red-800 text-sm">Logout</button>
                    </form>
                {% else %}
                    <a href="{% url 'account_login' %}" class="text-blue-600 hover:text-blue-800">Login</a>
                    <a href="{% url 'account_signup' %}" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">Sign Up</a>
                {% endif %}
            </div>
        </div>
    </div>
</nav>

<!-- Main Content -->
<main class="flex-1 container max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    {% if messages %}
      <div class="fixed top-4 right-4 z-50 space-y-3">
        {% for message in messages %}
          <div class="bg-green-50 border border-green-200 text-green-800 px-4 py-3 rounded-lg shadow mb-3">
            {{ message }}
          </div>
        {% endfor %}
      </div>
    {% endif %}

    {% block content %}{% endblock %}
</main>

<!-- Footer -->
<footer class="bg-white border-t border-gray-200 mt-auto">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 text-center text-sm text-gray-500">
        © 2025 ComplyLaw. All rights reserved.
    </div>
</footer>

<!-- Toast container -->
<div id="toast-container" class="fixed bottom-4 right-4 z-50 space-y-3"></div>

<!-- Canvas confetti -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.3/dist/confetti.browser.min.js"></script>

<!-- WebSocket notifications -->
<script>
(function() {
    const userId = "{{ user.id }}";
    if (!userId) return;

    const wsScheme = window.location.protocol === "https:" ? "wss" : "ws";
    const socket = new WebSocket(`${wsScheme}://${window.location.host}/ws/notifications/`);

    let hasCelebrated = false;

    socket.onmessage = function(e) {
        try {
            const data = JSON.parse(e.data);
            const message = data.message || "";
            const grade = data.grade;

            if (!grade) return;

            if (grade === "A" && !hasCelebrated) {
                hasCelebrated = true;
                celebrateGradeA(message);
            } else {
                showToast(message, grade, data.risk_score || 0);
            }
        } catch (err) {
            console.error("Invalid WS message:", err, e.data);
        }
    };

    function showToast(message, grade, risk=0) {
        const toast = document.createElement("div");
        const gradeColor = grade === "A" ? "bg-green-500" :
                           grade === "B" ? "bg-blue-500" :
                           grade === "C" ? "bg-yellow-500" :
                           grade === "D" ? "bg-orange-500" : "bg-red-500";

        toast.className = `max-w-sm w-full bg-white shadow-lg rounded-lg pointer-events-auto ring-1 ring-black ring-opacity-5 overflow-hidden transform transition-all duration-300 translate-y-10 opacity-0`;
        toast.innerHTML = `
            <div class="p-4 flex items-start">
                <div class="flex-1">
                    <p class="text-sm font-medium text-gray-900">${message}</p>
                    <p class="mt-1 text-xs text-gray-500">Grade: <strong>${grade}</strong> • Risk: ${risk}%</p>
                </div>
                <button onclick="this.parentElement.parentElement.remove()" class="ml-4 text-gray-400 hover:text-gray-500">&times;</button>
            </div>
            <div class="h-1 ${gradeColor}" style="width:0%"></div>
        `;
        document.getElementById("toast-container").prepend(toast);

        setTimeout(() => {
            toast.classList.remove("translate-y-10", "opacity-0");
            toast.querySelector("div.h-1").style.width = "100%";
            toast.querySelector("div.h-1").style.transition = "width 5s linear";
        }, 100);

        setTimeout(() => {
            toast.remove();
        }, 6000);
    }

    function celebrateGradeA(message) {
        // Confetti
        const duration = 6000;
        const animationEnd = Date.now() + duration;
        const defaults = { startVelocity: 30, spread: 360, ticks: 60, zIndex: 9999 };

        function randomInRange(min, max) { return Math.random() * (max - min) + min; }

        const interval = setInterval(() => {
            const timeLeft = animationEnd - Date.now();
            if (timeLeft <= 0) return clearInterval(interval);
            const particleCount = 80 * (timeLeft / duration);
            confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.1,0.3), y: Math.random() - 0.2 }}));
            confetti(Object.assign({}, defaults, { particleCount, origin: { x: randomInRange(0.7,0.9), y: Math.random() - 0.2 }}));
        }, 250);

        // Final big burst
        setTimeout(() => {
            confetti({ particleCount: 300, spread: 120, origin: { y: 0.6 },
                       colors: ['#10b981','#34d399','#86efac','#d9f99d','#fbbf24'] });
        }, 2000);

        // Victory toast
        const epicToast = document.createElement("div");
        epicToast.className = "fixed inset-0 flex items-center justify-center z-[99999] pointer-events-none";
        epicToast.innerHTML = `
            <div class="bg-gradient-to-br from-green-400 via-emerald-500 to-teal-600 text-white px-12 py-10 rounded-3xl shadow-2xl transform scale-0 animate-ping-once">
                <div class="text-center">
                    <div class="text-6xl font-black mb-4 animate-bounce">A</div>
                    <div class="text-3xl font-bold">${message}</div>
                    <div class="text-xl mt-3 opacity-90">Outstanding Compliance!</div>
                </div>
            </div>
        `;
        document.body.appendChild(epicToast);
        setTimeout(() => epicToast.remove(), 5000);

        // Sound
        const audio = new Audio("https://assets.mixkit.co/sfx/preview/mixkit-achievement-bell-600.mp3");
        audio.volume = 0.6;
        audio.play().catch(() => {});
    }

    // Ping-once animation
    const style = document.createElement('style');
    style.textContent = `
        @keyframes ping-once {0% { transform: scale(0); opacity: 0; } 50% { opacity: 1; } 100% { transform: scale(1.1); opacity: 0; }}
        .animate-ping-once { animation: ping-once 4s cubic-bezier(0,0,0.2,1) forwards; }
    `;
    document.head.appendChild(style);

})();
</script>

{% block scripts %}{% endblock %}

</body>
</html>
